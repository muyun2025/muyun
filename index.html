<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MUYUN 會員系統 | muyun2026</title>
  
  <!-- 1. 載入 Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 2. 設定模組對應 -->
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
        "lucide-react": "https://esm.sh/lucide-react@0.294.0"
      }
    }
  </script>

  <!-- 3. Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* 2026 火馬年主題配色：深黑底 + 赤紅 + 流金 */
    body { background-color: #0F0505; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
    
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #1a0b0b; }
    ::-webkit-scrollbar-thumb { background: #451a1a; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #7f1d1d; }
    
    /* 極光背景動畫 */
    .orb { position: fixed; border-radius: 50%; filter: blur(100px); z-index: -1; pointer-events: none; animation: float 15s infinite ease-in-out; }
    .orb-1 { top: -10%; left: -10%; width: 60vw; height: 60vw; background: rgba(220, 38, 38, 0.15); } 
    .orb-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: rgba(245, 158, 11, 0.12); animation-delay: -5s; }
    
    @keyframes float { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(20px, 20px); } }
    
    /* UI 特效 */
    .tech-input:focus { box-shadow: 0 0 15px rgba(239, 68, 68, 0.3); border-color: #ef4444; }
    .glass-card { background: rgba(20, 5, 5, 0.7); backdrop-filter: blur(16px); border: 1px solid rgba(127, 29, 29, 0.3); }
    
    .chat-enter { animation: slideUp 0.3s ease-out forwards; }
    .cart-enter { animation: slideLeft 0.3s ease-out forwards; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes slideLeft { from { transform: translateX(100%); } to { transform: translateX(0); } }
  </style>
</head>
<body class="min-h-screen relative">
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { initializeApp } from 'firebase/app';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
    import { getFirestore, collection, doc, setDoc, getDocs, updateDoc, deleteDoc, onSnapshot, arrayUnion, writeBatch } from 'firebase/firestore';
    import { 
      User, Mail, Star, CreditCard, LogOut, Search, Plus, Trash2, Edit3, ChevronRight, 
      ShieldCheck, LayoutDashboard, UserPlus, Image as ImageIcon, Camera, Download, Upload, Gift, 
      History, TrendingUp, Phone, MapPin, Calendar, ShoppingBag, Tag, Package, ShoppingCart,
      Settings, Save, X, Truck, CheckCircle, Zap, Cpu, AlertTriangle, Bell, Megaphone, Info,
      MessageCircle, Send, MessageSquare, ExternalLink, Lock, Minus, ArrowRight, Flame, HelpCircle, FileJson, FileSpreadsheet
    } from 'lucide-react';

    // --- ⚠️ 請在此填入 Firebase 設定 ⚠️ ---
    let firebaseConfig = {
      apiKey: "AIzaSyA1oYaOhVjIjR1TOmsJ_9LTIGvbuRxD_OI",

  authDomain: "muyun-system.firebaseapp.com",

  projectId: "muyun-system",

  storageBucket: "muyun-system.firebasestorage.app",

  messagingSenderId: "624450482056",

  appId: "1:624450482056:web:3930e7d7c8392fb68c143d",

  measurementId: "G-RNYN5YG02W"
    };

    const LINE_ID = "muyun_official"; 
    let currentAppId = 'membership-system-tech';
    let initialAuthToken = undefined;

    // 自動偵測環境變數
    if (typeof __firebase_config !== 'undefined') {
      try {
        firebaseConfig = JSON.parse(__firebase_config);
        if (typeof __app_id !== 'undefined') currentAppId = __app_id;
        if (typeof __initial_auth_token !== 'undefined') initialAuthToken = __initial_auth_token;
      } catch (e) { console.warn("使用手動設定模式"); }
    }

    let app, auth, db;
    let isConfigured = true;

    try {
      if (firebaseConfig.apiKey.includes("請填入")) {
        console.error("設定未填寫");
        isConfigured = false;
      } else {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
      }
    } catch (e) { isConfigured = false; }

    const DEFAULT_PRODUCTS = [
      { id: 'p1', name: '量子修復納豆激酶', price: 1800, desc: '奈米級吸收技術，啟動代謝循環', image: 'https://images.unsplash.com/photo-1615485925763-867862f80d29?auto=format&fit=crop&q=80&w=400' },
      { id: 'p2', name: '光子嫩膚眼膠', price: 1200, desc: '生物光波傳導，重現明亮雙眸', image: 'https://images.unsplash.com/photo-1620916566398-39f1143ab7be?auto=format&fit=crop&q=80&w=400' }
    ];

    const DEFAULT_RULES = [
      { points: 3000, rate: 0.7, label: "VVIP 黑卡 7折" },
      { points: 1000, rate: 0.8, label: "VIP 金卡 8折" }
    ];

    // 使用 Unsplash 的雲朵照片作為 Logo
    const CLOUD_LOGO_URL = "https://images.unsplash.com/photo-1534088568595-a066f410bcda?auto=format&fit=crop&q=80&w=200&h=200";

    const App = () => {
      // User State
      const [user, setUser] = useState(null);
      const [isAdmin, setIsAdmin] = useState(false);
      const [view, setView] = useState('login'); 
      const [adminTab, setAdminTab] = useState('members');
      const [loading, setLoading] = useState(true);

      // Data State
      const [memberData, setMemberData] = useState(null);
      const [allMembers, setAllMembers] = useState([]);
      const [products, setProducts] = useState([]);
      const [discountRules, setDiscountRules] = useState([]);
      const [newsList, setNewsList] = useState([]);
      const [cart, setCart] = useState([]);
      const [showCart, setShowCart] = useState(false);
      const [searchTerm, setSearchTerm] = useState('');

      // Chat States
      const [chatOpen, setChatOpen] = useState(false);
      const [chatMessages, setChatMessages] = useState([]);
      const [chatInput, setChatInput] = useState('');
      const [adminActiveChatId, setAdminActiveChatId] = useState(null);
      const [allChats, setAllChats] = useState([]);
      const chatEndRef = useRef(null);

      // Form State
      const [loginForm, setLoginForm] = useState({ email: '', password: '' });
      const [signupForm, setSignupForm] = useState({ name: '', email: '', password: '', phone: '', address: '', birthday: '', photo: '' });
      
      const [productForm, setProductForm] = useState({ id: '', name: '', price: '', desc: '', image: '' });
      const [editingProduct, setEditingProduct] = useState(false);
      const [tempRules, setTempRules] = useState([]); 
      const [newMember, setNewMember] = useState({ name: '', email: '', phone: '', address: '', birthday: '', points: 0, level: '一般會員', photo: '' });
      const [newsForm, setNewsForm] = useState({ title: '', content: '' });
      const [paymentForm, setPaymentForm] = useState({ orderId: '', last5: '', date: '' });
      const [pointForm, setPointForm] = useState({ memberId: '', memberName: '', amount: 10, reason: '' });

      // Modals
      const [showAddMemberModal, setShowAddMemberModal] = useState(false);
      const [showProductModal, setShowProductModal] = useState(false);
      const [showPointModal, setShowPointModal] = useState(false);
      const [showOrderDetailModal, setShowOrderDetailModal] = useState(false);
      const [showNewsModal, setShowNewsModal] = useState(false);
      const [showPaymentModal, setShowPaymentModal] = useState(false);
      const [selectedOrder, setSelectedOrder] = useState(null);
      
      const [showAuthErrorModal, setShowAuthErrorModal] = useState(false);

      // --- Initialization ---
      useEffect(() => {
        if (!auth || !isConfigured) return; 

        // 初始化時強制登出
        signOut(auth).catch((e) => console.error(e));

        return onAuthStateChanged(auth, (u) => {
          if (u) {
            setUser(u);
            if (u.email === 'admin@system.com' || (memberData && memberData.level === 'admin')) {
              setIsAdmin(true); setView('admin');
            } else {
              setIsAdmin(false); setView('dashboard');
            }
          } else {
            setUser(null); setView('login');
          }
          setLoading(false);
        });
      }, []);

      // --- Data Listeners ---
      useEffect(() => {
        if (!user || !db) return;

        const unsubProducts = onSnapshot(collection(db, 'artifacts', currentAppId, 'public', 'data', 'products'), (snap) => {
          if (snap.empty) DEFAULT_PRODUCTS.forEach(p => setDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'products', p.id), p));
          else setProducts(snap.docs.map(d => d.data()));
        });

        const unsubSettings = onSnapshot(doc(db, 'artifacts', currentAppId, 'public', 'data', 'settings', 'config'), (docSnap) => {
          if (docSnap.exists()) {
            setDiscountRules(docSnap.data().rules || []);
            setTempRules(docSnap.data().rules || []);
          } else {
            setDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'settings', 'config'), { rules: DEFAULT_RULES });
          }
        });

        const unsubNews = onSnapshot(collection(db, 'artifacts', currentAppId, 'public', 'data', 'news'), (snap) => {
          const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          list.sort((a, b) => new Date(b.date) - new Date(a.date));
          setNewsList(list);
        });

        let unsubMembers = () => {};
        if (isAdmin) {
          unsubMembers = onSnapshot(collection(db, 'artifacts', currentAppId, 'public', 'data', 'members'), (snap) => {
            setAllMembers(snap.docs.map(d => ({ id: d.id, ...d.data() })));
          });
        } else {
          unsubMembers = onSnapshot(doc(db, 'artifacts', currentAppId, 'public', 'data', 'members', user.uid), (docSnap) => {
            if (docSnap.exists()) {
              setMemberData({ id: docSnap.id, ...docSnap.data() });
              if (docSnap.data().email === 'admin@system.com') { setIsAdmin(true); setView('admin'); }
            }
          });
        }

        let unsubChat = () => {};
        let unsubAllChats = () => {};

        if (memberData && !isAdmin) {
           const chatDocRef = doc(db, 'artifacts', currentAppId, 'public', 'data', 'chats', memberData.id);
           unsubChat = onSnapshot(collection(chatDocRef, 'messages'), (snap) => {
             const msgs = snap.docs.map(d => d.data()).sort((a, b) => a.timestamp - b.timestamp);
             setChatMessages(msgs);
             setTimeout(() => chatEndRef.current?.scrollIntoView({ behavior: "smooth" }), 100);
           });
        }

        if (isAdmin) {
           unsubAllChats = onSnapshot(collection(db, 'artifacts', currentAppId, 'public', 'data', 'chats'), (snap) => {
             const chats = snap.docs.map(d => ({ id: d.id, ...d.data() }));
             const chatsWithNames = chats.map(c => {
               const m = allMembers.find(m => m.id === c.id);
               return { ...c, name: m ? m.name : c.id, photo: m?.photo };
             });
             setAllChats(chatsWithNames);
           });

           if (adminActiveChatId) {
             const chatDocRef = doc(db, 'artifacts', currentAppId, 'public', 'data', 'chats', adminActiveChatId);
             unsubChat = onSnapshot(collection(chatDocRef, 'messages'), (snap) => {
               const msgs = snap.docs.map(d => d.data()).sort((a, b) => a.timestamp - b.timestamp);
               setChatMessages(msgs);
               setTimeout(() => chatEndRef.current?.scrollIntoView({ behavior: "smooth" }), 100);
             });
           }
        }

        return () => { unsubProducts(); unsubSettings(); unsubNews(); unsubMembers(); unsubChat(); unsubAllChats(); };
      }, [user, isAdmin, adminActiveChatId, allMembers.length]); 

      const showToast = (msg, type='info') => {
        const el = document.createElement('div');
        const bgClass = type === 'error' ? 'bg-red-600/90 border-red-400/50' : 'bg-amber-600/90 border-amber-400/50';
        el.className = `fixed top-4 left-1/2 -translate-x-1/2 ${bgClass} text-white px-6 py-3 rounded-lg shadow-[0_0_20px_rgba(251,191,36,0.3)] z-[100] animate-bounce font-bold backdrop-blur-md border border-white/20`;
        el.innerText = msg;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 3000);
      };

      const getDiscountInfo = (points) => {
        const sortedRules = [...discountRules].sort((a, b) => b.points - a.points);
        const applicable = sortedRules.find(r => points >= r.points);
        return applicable ? { rate: applicable.rate, label: applicable.label } : { rate: 1, label: "無折扣" };
      };

      // --- Actions ---
      const handleLogin = async (e) => {
        if(e) e.preventDefault();
        if (!loginForm.email || !loginForm.password) { showToast('請輸入帳號密碼', 'error'); return; }
        try { await signInWithEmailAndPassword(auth, loginForm.email, loginForm.password); showToast('登入成功'); } 
        catch (e) { 
          if(e.code === 'auth/operation-not-allowed') {
            setShowAuthErrorModal(true);
          } else {
            showToast('登入失敗：' + e.message, 'error'); 
          }
        }
      };

      const handleSignup = async (e) => {
        if(e) e.preventDefault();
        if (!signupForm.name || !signupForm.email || !signupForm.password) { showToast('請填寫完整資料 (含密碼)', 'error'); return; }
        try {
          const cred = await createUserWithEmailAndPassword(auth, signupForm.email, signupForm.password);
          const uid = cred.user.uid;
          const initialPoints = 200;
          const data = { id: uid, ...signupForm, password: null, level: '一般會員', points: initialPoints, history: [{ date: new Date().toISOString(), reason: '入會禮', change: initialPoints }], orders: [], createdAt: new Date().toISOString(), photo: signupForm.photo || `https://api.dicebear.com/7.x/avataaars/svg?seed=${signupForm.name}` };
          delete data.password;
          await setDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'members', uid), data);
          showToast(`註冊成功！`);
        } catch (e) { 
          if(e.code === 'auth/operation-not-allowed') {
             setShowAuthErrorModal(true);
          } else if(e.code === 'auth/email-already-in-use') {
            showToast('此 Email 已被使用', 'error');
          } else {
            showToast('註冊失敗: ' + e.message, 'error'); 
          }
        }
      };

      const addToCart = (product) => {
        setCart(prev => {
          const exist = prev.find(i => i.id === product.id);
          if (exist) return prev.map(i => i.id === product.id ? { ...i, quantity: i.quantity + 1 } : i);
          return [...prev, { ...product, quantity: 1 }];
        });
        setShowCart(true); // 自動打開購物車
      };
      const updateCartQty = (id, delta) => setCart(prev => prev.map(i => i.id === id ? { ...i, quantity: Math.max(1, i.quantity + delta) } : i));
      const removeFromCart = (id) => setCart(prev => prev.filter(i => i.id !== id));
      const cartTotal = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
      const discountInfo = memberData ? getDiscountInfo(memberData.points) : { rate: 1, label: '' };
      const finalTotal = Math.round(cartTotal * discountInfo.rate);

      const handleCheckout = async () => {
        if (cart.length === 0 || !memberData) return;
        const newOrder = {
          orderId: `ORD-${Date.now().toString().slice(-6)}`,
          date: new Date().toISOString(),
          items: cart.map(i => ({ name: i.name, quantity: i.quantity, unitPrice: i.price, discountRate: discountInfo.rate })),
          totalAmount: finalTotal,
          status: 'pending',
          shippingInfo: { name: memberData.name, phone: memberData.phone, address: memberData.address, email: memberData.email }
        };
        try {
          const ref = doc(db, 'artifacts', currentAppId, 'public', 'data', 'members', memberData.id);
          await updateDoc(ref, { orders: arrayUnion(newOrder) });
          setCart([]); setShowCart(false); showToast('訂單已送出！請至「我的帳戶」查看'); setView('dashboard');
        } catch (e) { showToast('結帳失敗', 'error'); }
      };

      const handleSendMessage = async (sender) => {
        if (!chatInput.trim()) return;
        const targetId = isAdmin ? adminActiveChatId : memberData.id;
        if (!targetId) return;
        const chatDocRef = doc(db, 'artifacts', currentAppId, 'public', 'data', 'chats', targetId);
        try {
          await setDoc(chatDocRef, { lastMessage: chatInput, lastMessageTime: Date.now(), hasUnread: true }, { merge: true });
          await setDoc(doc(collection(chatDocRef, 'messages')), { sender, text: chatInput, timestamp: Date.now() });
          setChatInput('');
        } catch (e) { console.error(e); }
      };

      const filteredMembers = allMembers.filter(m => {
        if (!searchTerm) return true;
        const term = searchTerm.toLowerCase();
        return (m.name?.toLowerCase().includes(term) || m.email?.toLowerCase().includes(term) || m.phone?.includes(term));
      });

      const handleReportPayment = async () => {
        if (!paymentForm.last5) { showToast('請填寫資料', 'error'); return; }
        const updatedOrders = memberData.orders.map(o => o.orderId === paymentForm.orderId ? { ...o, status: 'verifying', paymentInfo: { method: 'remittance', last5: paymentForm.last5, date: paymentForm.date } } : o);
        await updateDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'members', memberData.id), { orders: updatedOrders });
        showToast('回報成功'); setShowPaymentModal(false);
      };
      
      const handleConfirmPayment = async (oid, mid) => {
        const m = allMembers.find(x => x.id === mid); if(!m) return;
        const updatedOrders = m.orders.map(o => o.orderId === oid ? { ...o, status: 'paid_confirmed' } : o);
        await updateDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'members', mid), { orders: updatedOrders });
        if(selectedOrder && selectedOrder.orderId === oid) setSelectedOrder({...selectedOrder, status: 'paid_confirmed'});
        showToast('已確認收款');
      };

      const handleUpdateOrderStatus = async (mid, oid, status) => {
        const m = allMembers.find(x => x.id === mid); if(!m) return;
        const updatedOrders = m.orders.map(o => o.orderId === oid ? { ...o, status } : o);
        await updateDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'members', mid), { orders: updatedOrders });
        if(selectedOrder && selectedOrder.orderId === oid) setSelectedOrder({...selectedOrder, status});
        showToast('狀態更新');
      };

      const handleAdminAddMember = async () => {
        if (!newMember.email) return;
        const id = `M${Date.now()}`;
        const data = { ...newMember, id, points: Number(newMember.points)||0, history: [], orders: [], createdAt: new Date().toISOString(), photo: newMember.photo || `https://api.dicebear.com/7.x/avataaars/svg?seed=${newMember.name}` };
        await setDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'members', id), data);
        setShowAddMemberModal(false); showToast('已新增會員');
      };

      const handleSaveProduct = async () => {
        const id = editingProduct ? productForm.id : `p${Date.now()}`;
        await setDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'products', id), { ...productForm, id, price: Number(productForm.price) });
        setShowProductModal(false); showToast('商品儲存');
      };
      const handleDeleteProduct = async (id) => { await deleteDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'products', id)); showToast('商品刪除'); };
      const handlePublishNews = async () => { const id = `news_${Date.now()}`; await setDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'news', id), { ...newsForm, id, date: new Date().toISOString() }); setNewsForm({title:'',content:''}); showToast('公告發布'); };
      const handleDeleteNews = async (id) => { await deleteDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'news', id)); showToast('公告刪除'); };
      const handleSaveRules = async () => { await setDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'settings', 'config'), { rules: tempRules }); showToast('設定儲存'); };
      const handlePointAdj = async () => {
        const m = allMembers.find(x => x.id === pointForm.memberId); if(!m) return;
        const newPoints = (m.points || 0) + Number(pointForm.amount);
        await updateDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'members', pointForm.memberId), { points: newPoints, history: arrayUnion({ date: new Date().toISOString(), reason: pointForm.reason, change: Number(pointForm.amount) }) });
        setShowPointModal(false); showToast('點數更新');
      };

      // --- Import / Export Logic (Modified to JSON) ---
      const exportData = () => {
        if (allMembers.length === 0) { showToast('無資料可匯出', 'error'); return; }
        const jsonString = JSON.stringify(allMembers, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `MUYUN_Backup_${new Date().toISOString().slice(0,10)}.json`;
        link.click();
        URL.revokeObjectURL(url);
        showToast('已匯出完整資料備份 (JSON)');
      };

      const exportReport = () => {
         if (allMembers.length === 0) { showToast('無資料可匯出', 'error'); return; }
         const headers = ['ID,姓名,電話,Email,點數,等級,訂單數,總消費'];
         const csv = allMembers.map(m => {
           const orderCount = m.orders ? m.orders.length : 0;
           const totalSpent = m.orders ? m.orders.reduce((acc, curr) => acc + curr.totalAmount, 0) : 0;
           return `${m.id},"${m.name}","${m.phone||''}",${m.email},${m.points},${m.level},${orderCount},${totalSpent}`;
         }).join('\n');
         const blob = new Blob(['\uFEFF'+headers+'\n'+csv], {type:'text/csv'});
         const url = URL.createObjectURL(blob);
         const link = document.createElement('a');
         link.href = url;
         link.download = `MUYUN_Report_${new Date().toISOString().slice(0,10)}.csv`;
         link.click();
         URL.revokeObjectURL(url);
         showToast('已下載營運報表 (CSV)');
      };

      const handleImportData = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (event) => {
          try {
            const importedData = JSON.parse(event.target.result);
            if (!Array.isArray(importedData)) throw new Error('格式錯誤');
            
            const batch = writeBatch(db);
            let count = 0;
            importedData.forEach(member => {
              if (member.id) {
                 const ref = doc(db, 'artifacts', currentAppId, 'public', 'data', 'members', member.id);
                 batch.set(ref, member, { merge: true });
                 count++;
              }
            });
            await batch.commit();
            showToast(`成功還原 ${count} 筆會員資料 (含訂單記錄)`);
          } catch (err) {
            console.error(err);
            showToast('還原失敗：檔案格式不正確 (請使用 .json 備份檔)', 'error');
          }
        };
        reader.readAsText(file);
        e.target.value = ''; 
      };

      if (!isConfigured) return <div className="flex flex-col items-center justify-center min-h-screen text-center p-6 space-y-6 text-white"><AlertTriangle size={48} className="text-red-500" /><h1>請設定 index.html 中的 Firebase Config</h1></div>;
      if (loading) return <div className="flex justify-center items-center h-screen bg-[#0F0505] text-red-500"><div className="animate-spin rounded-full h-12 w-12 border-4 border-red-500 border-t-transparent shadow-[0_0_20px_rgba(239,68,68,0.5)]"></div></div>;

      return (
        <div className="min-h-screen bg-[#0F0505] font-sans text-slate-200 selection:bg-red-500/30 pb-20 relative">
          <div className="orb orb-1"></div><div className="orb orb-2"></div>
          
          {/* Navbar */}
          {user && (
            <nav className="bg-[#1a0b0b]/80 backdrop-blur-md border-b border-red-900/30 px-6 py-4 sticky top-0 z-20 flex justify-between items-center shadow-lg">
              <div className="flex items-center gap-2 font-bold text-xl text-red-500 cursor-pointer tracking-wider" onClick={() => !user && setView('login')}>
                <img src={CLOUD_LOGO_URL} alt="Logo" className="w-8 h-8 rounded-full object-cover" /> <span>MUYUN<span className="text-white">會員系統</span></span>
              </div>
              <div className="flex items-center gap-3">
                {!isAdmin ? (
                  <>
                    <button onClick={() => setView('shop')} className={`flex items-center gap-2 px-3 py-2 rounded-full transition-all ${view==='shop'?'bg-red-900/40 text-red-400 border border-red-500/50':'text-slate-400 hover:text-white hover:bg-white/5'}`}><ShoppingBag size={18}/> <span className="hidden sm:inline">商城</span></button>
                    <button onClick={() => setView('dashboard')} className={`flex items-center gap-2 px-3 py-2 rounded-full transition-all ${view==='dashboard'?'bg-red-900/40 text-red-400 border border-red-500/50':'text-slate-400 hover:text-white hover:bg-white/5'}`}><LayoutDashboard size={18}/> <span className="hidden sm:inline">帳戶</span></button>
                    <button onClick={() => setShowCart(true)} className="relative p-2 text-slate-400 hover:text-amber-400 transition-colors"><ShoppingCart size={20}/>{cart.length>0 && <span className="absolute -top-1 -right-1 bg-amber-500 text-black text-[10px] w-4 h-4 flex items-center justify-center rounded-full font-bold">{cart.length}</span>}</button>
                    <button onClick={() => setShowNewsModal(true)} className="relative p-2 text-slate-400 hover:text-amber-400 transition-colors"><Bell size={20}/>{newsList.length>0 && <span className="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>}</button>
                  </>
                ) : (
                  <span className="px-3 py-1 bg-amber-900/30 border border-amber-500/50 text-amber-500 text-xs rounded-full">ADMIN</span>
                )}
                <div className="w-px h-6 bg-white/10 mx-2"></div>
                <button onClick={() => { signOut(auth); setUser(null); setCart([]); }} className="text-slate-500 hover:text-red-400"><LogOut size={18}/></button>
              </div>
            </nav>
          )}

          <main className="max-w-6xl mx-auto p-4 md:p-8 relative">
            {/* Login View */}
            {view === 'login' && (
              <div className="flex flex-col items-center justify-center min-h-[80vh]">
                <div className="w-full max-w-md p-8 glass-card rounded-3xl shadow-2xl relative overflow-hidden group">
                  <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-red-500 to-transparent opacity-50"></div>
                  <div className="text-center mb-8 relative z-10">
                    <div className="w-24 h-24 bg-[#1a0b0b] rounded-full flex items-center justify-center mx-auto mb-6 border border-red-500/30 shadow-[0_0_30px_rgba(239,68,68,0.2)] overflow-hidden">
                       <img src={CLOUD_LOGO_URL} alt="Logo" className="w-full h-full object-cover" />
                    </div>
                    <h2 className="text-3xl font-bold text-white tracking-wide mb-2">會員登入</h2>
                    <p className="text-slate-400 text-sm">muyun2026</p>
                  </div>
                  <form className="space-y-5 relative z-10" onSubmit={handleLogin}>
                    <div className="relative group/input"><Mail className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 group-focus-within/input:text-red-400" size={20}/><input type="email" placeholder="電子郵件" className="tech-input w-full p-4 pl-12 bg-[#0F0505]/80 border border-slate-800 rounded-xl text-white outline-none transition-all duration-300" value={loginForm.email} onChange={e => setLoginForm({...loginForm, email: e.target.value})} /></div>
                    <div className="relative group/input"><Lock className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 group-focus-within/input:text-red-400" size={20}/><input type="password" placeholder="密碼" className="tech-input w-full p-4 pl-12 bg-[#0F0505]/80 border border-slate-800 rounded-xl text-white outline-none transition-all duration-300" value={loginForm.password} onChange={e => setLoginForm({...loginForm, password: e.target.value})} /></div>
                    <button type="submit" className="w-full bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 text-white py-4 rounded-xl font-bold shadow-[0_0_20px_rgba(239,68,68,0.4)] hover:shadow-[0_0_30px_rgba(249,115,22,0.6)] transition-all duration-300 transform active:scale-[0.98] flex items-center justify-center gap-2"><span>連接系統</span><ArrowRight size={16}/></button>
                    <div className="flex justify-between items-center pt-2 text-sm"><span className="text-slate-500 cursor-pointer hover:text-slate-300">忘記密碼？</span><span onClick={() => setView('signup')} className="text-amber-500 hover:text-amber-400 hover:underline cursor-pointer">註冊新帳號</span></div>
                  </form>
                  <div className="absolute bottom-3 right-5 text-[10px] text-slate-700 font-mono tracking-widest opacity-50">muyun</div>
                </div>
              </div>
            )}

            {/* Signup View */}
            {view === 'signup' && (
              <div className="flex flex-col items-center justify-center min-h-[80vh]">
                <div className="w-full max-w-lg p-8 glass-card rounded-3xl shadow-2xl relative overflow-hidden">
                  <div className="text-center mb-6 relative z-10 border-b border-red-900/30 pb-4">
                    <h2 className="text-2xl font-bold text-white">建立帳戶</h2><p className="text-amber-500 text-sm mt-1">立即加入，開啟鴻運年</p>
                  </div>
                  <form className="space-y-4 relative z-10" onSubmit={handleSignup}>
                    <div className="grid grid-cols-2 gap-3">
                      <input type="text" placeholder="姓名 *" className="tech-input w-full p-3 bg-[#0F0505]/80 border border-slate-800 rounded-xl text-white outline-none" value={signupForm.name} onChange={e => setSignupForm({...signupForm, name: e.target.value})} />
                      <input type="tel" placeholder="電話 *" className="tech-input w-full p-3 bg-[#0F0505]/80 border border-slate-800 rounded-xl text-white outline-none" value={signupForm.phone} onChange={e => setSignupForm({...signupForm, phone: e.target.value})} />
                    </div>
                    <input type="email" placeholder="Email *" className="tech-input w-full p-3 bg-[#0F0505]/80 border border-slate-800 rounded-xl text-white outline-none" value={signupForm.email} onChange={e => setSignupForm({...signupForm, email: e.target.value})} />
                    <input type="password" placeholder="設定密碼 *" className="tech-input w-full p-3 bg-[#0F0505]/80 border border-slate-800 rounded-xl text-white outline-none" value={signupForm.password} onChange={e => setSignupForm({...signupForm, password: e.target.value})} />
                    <div className="grid grid-cols-2 gap-3">
                      <input type="date" className="tech-input w-full p-3 bg-[#0F0505]/80 border border-slate-800 rounded-xl text-slate-400 outline-none" value={signupForm.birthday} onChange={e => setSignupForm({...signupForm, birthday: e.target.value})} />
                      <input type="text" placeholder="地址" className="tech-input w-full p-3 bg-[#0F0505]/80 border border-slate-800 rounded-xl text-white outline-none" value={signupForm.address} onChange={e => setSignupForm({...signupForm, address: e.target.value})} />
                    </div>
                    <button type="submit" className="w-full bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 text-white py-3 rounded-xl font-bold shadow-lg mt-2 transition-all">確認註冊</button>
                    <div className="text-center"><span onClick={() => setView('login')} className="text-slate-500 text-sm hover:text-white cursor-pointer">返回登入</span></div>
                  </form>
                </div>
              </div>
            )}

            {/* Dashboard */}
            {view === 'dashboard' && memberData && (
              <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4">
                <div className="bg-[#1a0b0b]/60 backdrop-blur-md p-8 rounded-3xl border border-red-900/30 flex flex-col md:flex-row gap-8 items-center relative overflow-hidden">
                  <div className="w-24 h-24 rounded-full bg-gradient-to-tr from-red-500 to-amber-500 p-[2px]"><img src={memberData.photo} className="w-full h-full rounded-full object-cover bg-[#0F0505]" /></div>
                  <div className="flex-1 text-center md:text-left">
                    <h2 className="text-3xl font-bold text-white">{memberData.name}</h2>
                    <div className="flex flex-wrap justify-center md:justify-start gap-2 mt-2">
                      <span className="px-3 py-1 bg-red-900/30 text-red-200 rounded-full text-sm border border-red-800/50">{memberData.level}</span>
                      <span className="px-3 py-1 bg-amber-900/30 text-amber-400 rounded-full text-sm border border-amber-500/30 flex items-center gap-1"><Tag size={14}/> {getDiscountInfo(memberData.points).label}</span>
                    </div>
                    <div className="mt-3 text-slate-400 text-sm">{memberData.email}</div>
                  </div>
                </div>

                <div className="grid md:grid-cols-2 gap-6">
                  <div className="bg-gradient-to-br from-red-900 to-[#1a0b0b] p-8 rounded-3xl text-white shadow-lg border border-red-500/20 relative overflow-hidden">
                    <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-20"></div>
                    <div className="relative z-10">
                      <div className="flex justify-between mb-8"><CreditCard size={32} className="text-amber-400" /> <span className="font-mono text-amber-500/50">POINTS</span></div>
                      <h3 className="text-6xl font-black my-2 text-transparent bg-clip-text bg-gradient-to-r from-white to-amber-200">{memberData.points}</h3>
                      <div className="w-full bg-[#0F0505]/50 h-1 mt-6 rounded-full overflow-hidden"><div className="h-full bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.8)]" style={{width: `${Math.min((memberData.points/1000)*100, 100)}%`}}></div></div>
                      <p className="text-xs text-amber-200/60 mt-2 font-mono text-right">Target: 1000 pts</p>
                    </div>
                  </div>
                  <div className="bg-[#1a0b0b]/60 backdrop-blur-md p-6 rounded-3xl border border-red-900/30 overflow-y-auto max-h-[300px]">
                    <h4 className="font-bold flex items-center gap-2 mb-4 text-white"><Package className="text-amber-400" /> 近期訂單</h4>
                    {memberData.orders?.length > 0 ? [...memberData.orders].reverse().map((o, i) => (
                      <div key={i} className="p-4 mb-3 bg-[#0F0505]/50 rounded-xl border border-red-900/20 flex flex-col gap-2 text-sm">
                        <div className="flex justify-between mb-2">
                          <div><div className="font-bold text-slate-200">{new Date(o.date).toLocaleDateString()}</div><div className="text-slate-500 text-xs">{o.items.length} 項商品</div></div>
                          <div className="text-right"><div className="font-bold text-amber-400">${o.totalAmount}</div><span className="text-xs text-slate-500">{o.status}</span></div>
                        </div>
                        {o.status === 'pending' && <button onClick={()=>{setPaymentForm({orderId:o.orderId,last5:'',date:''});setShowPaymentModal(true)}} className="w-full bg-red-900/30 text-xs py-2 rounded border border-red-800 hover:bg-red-800 text-white">回報匯款</button>}
                      </div>
                    )) : <div className="text-center text-slate-600 py-10">尚無訂單</div>}
                  </div>
                </div>
              </div>
            )}

            {/* Shop View */}
            {view === 'shop' && memberData && (
              <div className="animate-in fade-in slide-in-from-right-4">
                <div className="bg-gradient-to-r from-red-900 to-[#1a0b0b] rounded-3xl p-8 text-white mb-8 shadow-2xl border border-red-500/20">
                  <h2 className="text-3xl font-bold text-white">未來商城</h2>
                  <p className="opacity-80 mt-2 font-mono text-amber-200">BALANCE: {memberData.points} PTS <span className="bg-red-500/20 px-2 rounded text-xs ml-2 border border-red-500/30">{getDiscountInfo(memberData.points).label}</span></p>
                </div>
                <div className="grid md:grid-cols-2 gap-8">
                  {products.map(p => {
                    const { rate } = getDiscountInfo(memberData.points);
                    const price = Math.round(p.price * rate);
                    return (
                      <div key={p.id} className="bg-[#1a0b0b] border border-red-900/30 rounded-3xl overflow-hidden hover:border-amber-500/50 transition-all hover:shadow-[0_0_20px_rgba(245,158,11,0.1)]">
                        <div className="h-56 relative"><img src={p.image} className="w-full h-full object-cover" />{rate < 1 && <div className="absolute top-4 right-4 bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg">SALE</div>}</div>
                        <div className="p-6">
                          <h3 className="text-xl font-bold text-white mb-1">{p.name}</h3>
                          <div className="flex justify-between items-end mb-6"><div>{rate < 1 && <span className="text-slate-600 line-through text-xs mr-2">${p.price}</span>}<span className="text-3xl font-bold text-amber-400">${price}</span></div></div>
                          <button onClick={() => addToCart(p)} className="w-full bg-[#0F0505] text-white py-3 rounded-xl font-bold flex justify-center gap-2 hover:bg-red-600/20 border border-red-800 hover:border-red-500 transition-colors"><Plus size={18} /> 加入購物車</button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* Admin View */}
            {view === 'admin' && (
              <div className="space-y-6">
                <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                  <h2 className="text-2xl font-bold flex items-center gap-2 text-white"><ShieldCheck className="text-amber-400" /> 系統管理</h2>
                  <div className="flex bg-[#1a0b0b] p-1 rounded-xl border border-red-900/30">
                    {['members', 'products', 'orders', 'support', 'news', 'settings'].map(tab => (
                      <button key={tab} onClick={() => setAdminTab(tab)} className={`px-4 py-2 rounded-lg text-sm font-bold capitalize transition-colors ${adminTab === tab ? 'bg-red-900/40 text-amber-400 shadow' : 'text-slate-500 hover:text-slate-300'}`}>{tab === 'members' ? '會員' : tab === 'products' ? '商品' : tab === 'orders' ? '訂單' : tab === 'support' ? '客服' : tab === 'news' ? '公告' : '設定'}</button>
                    ))}
                  </div>
                </div>

                {/* Admin: Members */}
                {adminTab === 'members' && (
                  <div className="bg-[#1a0b0b] rounded-2xl border border-red-900/30 overflow-hidden shadow-xl">
                    <div className="p-4 border-b border-red-900/30 flex flex-wrap justify-between items-center bg-red-950/20 gap-2">
                      <div className="flex items-center gap-4">
                        <span className="font-bold text-slate-200">會員資料</span>
                        <div className="relative">
                          <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" size={16} />
                          <input type="text" placeholder="搜尋會員..." className="bg-[#0F0505] border border-red-900/50 rounded-full pl-10 pr-4 py-1 text-sm text-white outline-none focus:border-amber-500 w-64" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        </div>
                      </div>
                      <div className="flex gap-2">
                        {/* New Import/Export Buttons */}
                        <label className="bg-red-900/30 hover:bg-red-900/50 text-slate-300 px-3 py-1.5 rounded-lg text-sm flex items-center gap-1 cursor-pointer transition-colors border border-red-800/50">
                          <FileJson size={16} /> 匯入備份
                          <input type="file" accept=".json" onChange={handleImportData} hidden />
                        </label>
                        <button onClick={exportData} className="bg-red-900/30 hover:bg-red-900/50 text-slate-300 px-3 py-1.5 rounded-lg text-sm flex items-center gap-1 transition-colors border border-red-800/50">
                          <FileJson size={16} /> 匯出備份
                        </button>
                        <button onClick={exportReport} className="bg-amber-900/30 hover:bg-amber-900/50 text-amber-500 px-3 py-1.5 rounded-lg text-sm flex items-center gap-1 transition-colors border border-amber-800/50">
                          <FileSpreadsheet size={16} /> 下載報表
                        </button>
                        <button onClick={() => { setNewMember({name:'',email:'',phone:'',address:'',birthday:'',points:0,level:'一般會員',photo:''}); setShowAddMemberModal(true); }} className="bg-red-600 hover:bg-red-500 text-white px-3 py-1.5 rounded-lg text-sm flex items-center gap-1 ml-2"><Plus size={16} /> 新增</button>
                      </div>
                    </div>
                    <div className="overflow-x-auto">
                      <table className="w-full text-left text-sm text-slate-300">
                        <thead className="text-slate-500 border-b border-red-900/30 bg-red-950/10"><tr><th className="p-4">會員資訊</th><th className="p-4">點數</th><th className="p-4 text-right">操作</th></tr></thead>
                        <tbody className="divide-y divide-red-900/20">
                          {filteredMembers.map(m => (
                            <tr key={m.id} className="hover:bg-red-900/10">
                              <td className="p-4"><div className="font-bold text-white">{m.name}</div><div className="text-xs text-slate-500 font-mono">{m.email} | {m.phone}</div></td>
                              <td className="p-4 font-mono text-amber-400">{m.points}</td>
                              <td className="p-4 text-right">
                                <button onClick={() => { setPointForm({ memberId: m.id, memberName: m.name, amount: 10, reason: '' }); setShowPointModal(true); }} className="text-amber-500 bg-amber-900/20 px-3 py-1 rounded text-xs font-bold mr-2 hover:bg-amber-900/40">點數</button>
                                <button onClick={() => deleteDoc(doc(db, 'artifacts', currentAppId, 'public', 'data', 'members', m.id))} className="text-slate-600 hover:text-red-400"><Trash2 size={18} /></button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {/* Admin: Products */}
                {adminTab === 'products' && (
                  <div className="bg-[#1a0b0b] rounded-2xl border border-red-900/30 overflow-hidden">
                    <div className="p-4 border-b border-red-900/30 flex justify-between items-center bg-red-950/20">
                      <span className="font-bold text-slate-200">商品清單</span>
                      <button onClick={() => { setProductForm({ id: '', name: '', price: '', desc: '', image: '' }); setEditingProduct(false); setShowProductModal(true); }} className="bg-green-600 text-white px-3 py-1.5 rounded-lg text-sm flex items-center gap-1"><Plus size={16} /> 上架</button>
                    </div>
                    <div className="grid md:grid-cols-2 gap-4 p-4">
                      {products.map(p => (
                        <div key={p.id} className="flex gap-4 border border-red-900/30 bg-red-950/10 p-3 rounded-xl items-center">
                          <img src={p.image} className="w-16 h-16 rounded-lg object-cover bg-slate-800" />
                          <div className="flex-1"><div className="font-bold text-white">{p.name}</div><div className="text-sm text-amber-400">${p.price}</div></div>
                          <div className="flex gap-2">
                            <button onClick={() => { setProductForm(p); setEditingProduct(true); setShowProductModal(true); }} className="p-2 text-slate-400 hover:text-amber-400 bg-slate-900 rounded-lg"><Edit3 size={16} /></button>
                            <button onClick={() => handleDeleteProduct(p.id)} className="p-2 text-slate-400 hover:text-red-400 bg-slate-900 rounded-lg"><Trash2 size={16} /></button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Admin: Orders */}
                {adminTab === 'orders' && (
                  <div className="bg-[#1a0b0b] rounded-2xl border border-red-900/30 overflow-hidden">
                    <div className="p-4 border-b border-red-900/30 bg-red-950/20 font-bold text-slate-200">訂單監控</div>
                    <div className="overflow-x-auto">
                      <table className="w-full text-left text-sm text-slate-300">
                        <thead className="text-slate-500 border-b border-red-900/30 bg-red-950/10"><tr><th className="p-4">編號</th><th className="p-4">訂購人</th><th className="p-4">金額</th><th className="p-4">狀態</th><th className="p-4">匯款</th><th className="p-4 text-right">操作</th></tr></thead>
                        <tbody className="divide-y divide-red-900/20">
                          {allMembers.flatMap(m => (m.orders||[]).map(o => ({...o, memberId: m.id, memberName: m.name}))).sort((a,b)=>new Date(b.date)-new Date(a.date)).map(o => (
                            <tr key={o.orderId} className="hover:bg-red-900/10">
                              <td className="p-4 font-mono text-xs text-amber-500">{o.orderId}</td>
                              <td className="p-4">{o.shippingInfo?.name || o.memberName}</td>
                              <td className="p-4 font-bold text-white">${o.totalAmount}</td>
                              <td className="p-4"><span className={`px-2 py-1 rounded-full text-[10px] uppercase tracking-wider ${o.status==='shipped'?'bg-green-500/20 text-green-400':o.status==='paid_confirmed'?'bg-blue-500/20 text-blue-400':o.status==='verifying'?'bg-purple-500/20 text-purple-400':'bg-yellow-500/20 text-yellow-400'}`}>{o.status}</span></td>
                              <td className="p-4 text-xs font-mono text-slate-400">{o.paymentInfo?`後5: ${o.paymentInfo.last5}`:'-'}</td>
                              <td className="p-4 text-right flex justify-end gap-2">
                                {o.status==='verifying'&&<button onClick={()=>handleConfirmPayment(o.orderId,o.memberId)} className="text-blue-400 border border-blue-400 px-2 py-1 rounded text-xs">確認</button>}
                                <button onClick={()=>{setSelectedOrder({...o, memberId:o.memberId});setShowOrderDetailModal(true)}} className="text-slate-400 hover:text-white text-xs border border-slate-600 px-3 py-1 rounded">Detail</button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {/* Admin: Support */}
                {adminTab === 'support' && (
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-6 h-[600px]">
                    <div className="bg-[#1a0b0b] border border-red-900/30 rounded-2xl overflow-hidden flex flex-col">
                      <div className="p-4 bg-red-950/20 font-bold border-b border-red-900/30">對話列表</div>
                      <div className="flex-1 overflow-y-auto">
                        {allChats.map(c => (
                          <div key={c.id} onClick={() => setAdminActiveChatId(c.id)} className={`p-4 border-b border-red-900/20 cursor-pointer hover:bg-red-900/20 ${adminActiveChatId===c.id?'bg-red-900/30 border-l-4 border-amber-500':''}`}>
                            <div className="font-bold text-white">{c.name}</div><div className="text-xs text-slate-500 truncate">{c.lastMessage}</div>
                          </div>
                        ))}
                      </div>
                    </div>
                    <div className="md:col-span-2 bg-[#1a0b0b] border border-red-900/30 rounded-2xl overflow-hidden flex flex-col">
                      {adminActiveChatId ? (
                        <>
                          <div className="p-4 bg-red-950/20 font-bold border-b border-red-900/30">對話中</div>
                          <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-[#0F0505]/50">
                            {chatMessages.map((msg, i) => (<div key={i} className={`flex ${msg.sender==='admin'?'justify-end':'justify-start'}`}><div className={`max-w-[70%] p-3 rounded-xl text-sm ${msg.sender==='admin'?'bg-red-600 text-white':'bg-slate-800 text-slate-200'}`}>{msg.text}</div></div>))}
                            <div ref={chatEndRef}></div>
                          </div>
                          <div className="p-4 bg-red-950/20 border-t border-red-900/30 flex gap-2"><input type="text" className="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white outline-none" value={chatInput} onChange={e=>setChatInput(e.target.value)} onKeyPress={e=>e.key==='Enter'&&handleSendMessage('admin')} /><button onClick={()=>handleSendMessage('admin')} className="bg-red-600 text-white p-2 rounded-lg"><Send size={20}/></button></div>
                        </>
                      ) : <div className="flex-1 flex items-center justify-center text-slate-500">請選擇一個對話</div>}
                    </div>
                  </div>
                )}

                {/* Admin: News */}
                {adminTab === 'news' && (
                  <div className="bg-[#1a0b0b] rounded-2xl border border-red-900/30 p-6">
                    <h3 className="font-bold text-lg text-white mb-6 flex items-center gap-2"><Megaphone className="text-amber-400" /> 公告管理</h3>
                    <div className="bg-red-950/10 p-6 rounded-xl border border-red-900/30 mb-8 space-y-4">
                      <input type="text" placeholder="標題" className="w-full p-3 bg-[#0F0505] border border-red-900/50 rounded text-white outline-none focus:border-amber-500" value={newsForm.title} onChange={e=>setNewsForm({...newsForm,title:e.target.value})} />
                      <textarea placeholder="內容..." className="w-full p-3 bg-[#0F0505] border border-red-900/50 rounded text-white outline-none focus:border-amber-500 h-32" value={newsForm.content} onChange={e=>setNewsForm({...newsForm,content:e.target.value})}></textarea>
                      <button onClick={handlePublishNews} className="bg-red-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-red-500 shadow-lg">發布</button>
                    </div>
                    <div className="space-y-3">
                      {newsList.map(item => (
                        <div key={item.id} className="bg-red-950/10 p-4 rounded-xl border border-red-900/30 flex justify-between items-center group">
                          <div><div className="font-bold text-white">{item.title}</div><div className="text-slate-500 text-sm">{new Date(item.date).toLocaleDateString()}</div></div>
                          <button onClick={() => handleDeleteNews(item.id)} className="text-slate-600 hover:text-red-400 p-2 opacity-0 group-hover:opacity-100"><Trash2 size={18} /></button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Admin: Settings */}
                {adminTab === 'settings' && (
                  <div className="bg-[#1a0b0b] rounded-2xl border border-red-900/30 p-8">
                    <h3 className="font-bold text-lg text-white mb-6 flex items-center gap-2"><Settings className="text-amber-400" /> 折扣規則</h3>
                    <div className="space-y-4 mb-6">
                      {tempRules.map((rule, idx) => (
                        <div key={idx} className="flex gap-2 items-center bg-red-950/10 p-3 rounded-xl border border-red-900/30">
                          <input type="number" className="p-2 bg-[#0F0505] border border-slate-600 rounded text-white w-24 text-center" value={rule.points} onChange={e => { const n=[...tempRules]; n[idx].points=Number(e.target.value); setTempRules(n); }} />
                          <span className="text-slate-500 text-sm">點以上</span>
                          <input type="number" step="0.1" className="p-2 bg-[#0F0505] border border-slate-600 rounded text-white w-20 text-center" value={rule.rate} onChange={e => { const n=[...tempRules]; n[idx].rate=Number(e.target.value); setTempRules(n); }} />
                          <input type="text" className="p-2 bg-[#0F0505] border border-slate-600 rounded text-white flex-1" value={rule.label} onChange={e => { const n=[...tempRules]; n[idx].label=e.target.value; setTempRules(n); }} />
                          <button onClick={() => setTempRules(tempRules.filter((_,i)=>i!==idx))} className="text-slate-500 hover:text-red-400 p-2"><X size={18}/></button>
                        </div>
                      ))}
                      <button onClick={() => setTempRules([...tempRules, {points:0,rate:0.9,label:'新規則'}])} className="text-amber-400 text-sm flex items-center gap-1 mt-2"><Plus size={16}/> 新增規則</button>
                    </div>
                    <button onClick={handleSaveRules} className="bg-red-600 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-red-500"><Save size={18}/> 儲存</button>
                  </div>
                )}
              </div>
            )}
          </main>

          {/* Cart Sidebar */}
          {showCart && (
            <div className="fixed inset-0 z-[100] flex justify-end">
              <div className="absolute inset-0 bg-black/50 backdrop-blur-sm" onClick={() => setShowCart(false)}></div>
              <div className="relative w-full max-w-md bg-[#1a0b0b] border-l border-red-900/50 h-full shadow-2xl p-6 flex flex-col cart-enter z-[101]">
                <div className="flex justify-between items-center mb-6"><h3 className="text-xl font-bold text-white flex items-center gap-2"><ShoppingCart/> 購物車</h3><button onClick={()=>setShowCart(false)}><X className="text-slate-400 hover:text-white"/></button></div>
                <div className="flex-1 overflow-y-auto space-y-4">
                  {cart.length > 0 ? cart.map(item => (
                    <div key={item.id} className="bg-red-950/10 p-4 rounded-xl border border-red-900/30 flex gap-4">
                      <img src={item.image} className="w-16 h-16 rounded-lg object-cover" />
                      <div className="flex-1">
                        <div className="font-bold text-white">{item.name}</div><div className="text-sm text-amber-400">${item.price}</div>
                        <div className="flex items-center gap-3 mt-2"><button onClick={() => updateCartQty(item.id, -1)} className="w-6 h-6 rounded bg-slate-800 flex items-center justify-center text-white hover:bg-slate-700"><Minus size={14}/></button><span className="text-sm text-white font-mono w-4 text-center">{item.quantity}</span><button onClick={() => updateCartQty(item.id, 1)} className="w-6 h-6 rounded bg-slate-800 flex items-center justify-center text-white hover:bg-slate-700"><Plus size={14}/></button></div>
                      </div>
                      <button onClick={() => removeFromCart(item.id)} className="text-slate-500 hover:text-red-400 self-start"><Trash2 size={18}/></button>
                    </div>
                  )) : <div className="text-center text-slate-500 py-20">購物車是空的</div>}
                </div>
                {cart.length > 0 && (
                  <div className="border-t border-red-900/30 pt-4 mt-4">
                    <div className="flex justify-between text-sm text-slate-400 mb-2"><span>小計</span><span>${cartTotal}</span></div>
                    <div className="flex justify-between text-sm text-green-400 mb-4"><span>折扣 ({discountInfo.label})</span><span>{Math.round((1 - discountInfo.rate) * 100)}% OFF</span></div>
                    <div className="flex justify-between text-xl font-bold text-white mb-6"><span>總金額</span><span>${finalTotal}</span></div>
                    <button onClick={handleCheckout} className="w-full bg-gradient-to-r from-red-600 to-orange-600 text-white py-3 rounded-xl font-bold hover:shadow-lg">前往結帳</button>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* User Chat */}
          {!isAdmin && view!=='login' && view!=='signup' && (
            <div className="fixed bottom-6 right-6 z-50 flex flex-col items-end">
              {chatOpen && (
                <div className="mb-4 w-80 h-96 bg-[#1a0b0b] border border-red-900/50 rounded-2xl shadow-2xl flex flex-col overflow-hidden chat-enter">
                  <div className="p-4 bg-red-950/30 border-b border-red-900/30 flex justify-between items-center"><h3 className="font-bold text-white flex items-center gap-2"><MessageSquare size={18} className="text-amber-400"/> 線上客服</h3><button onClick={() => setChatOpen(false)}><X size={18} className="text-slate-400 hover:text-white"/></button></div>
                  <div className="bg-green-900/30 p-2 text-center border-b border-green-800/50"><p className="text-xs text-green-200 mb-1">需要傳送匯款單或圖片？</p><a href={`https://line.me/R/ti/p/@${LINE_ID}`} target="_blank" className="inline-flex items-center gap-1 bg-[#06C755] text-white text-xs px-3 py-1 rounded-full font-bold hover:bg-[#05b34c] transition-colors"><MessageCircle size={14} fill="currentColor" /> 加入 LINE@ 官方帳號 <ExternalLink size={10} /></a></div>
                  <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-[#0F0505]/50">
                    <div className="flex justify-start"><div className="max-w-[80%] p-3 rounded-xl text-sm bg-slate-800 text-slate-300">您好！有什麼我們可以幫您的嗎？</div></div>
                    {chatMessages.map((msg, i) => (<div key={i} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}><div className={`max-w-[80%] p-3 rounded-xl text-sm ${msg.sender === 'user' ? 'bg-red-700 text-white' : 'bg-slate-800 text-slate-300'}`}>{msg.text}</div></div>))}
                    <div ref={chatEndRef}></div>
                  </div>
                  <div className="p-3 bg-red-950/30 border-t border-red-900/30 flex gap-2"><input type="text" className="flex-1 bg-[#0F0505] border border-red-900/50 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-amber-500" placeholder="輸入訊息..." value={chatInput} onChange={e => setChatInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleSendMessage('user')} /><button onClick={() => handleSendMessage('user')} className="bg-red-600 text-white p-2 rounded-lg hover:bg-red-500"><Send size={18}/></button></div>
                </div>
              )}
              <button onClick={() => setChatOpen(!chatOpen)} className="bg-gradient-to-r from-red-600 to-orange-600 text-white p-4 rounded-full shadow-lg shadow-red-500/30 transition-all hover:scale-110">{chatOpen ? <X size={24} /> : <MessageCircle size={24} />}</button>
            </div>
          )}

          {/* Config Error Modal */}
          {showAuthErrorModal && (
            <div className="fixed inset-0 bg-black/90 backdrop-blur-xl z-[999] flex items-center justify-center p-6">
              <div className="bg-[#1a0b0b] border border-red-500 rounded-2xl w-full max-w-lg p-8 shadow-2xl relative">
                <button onClick={() => setShowAuthErrorModal(false)} className="absolute top-4 right-4 text-slate-400 hover:text-white"><X size={24} /></button>
                <div className="flex flex-col items-center text-center mb-6">
                  <div className="w-16 h-16 bg-red-900/30 rounded-full flex items-center justify-center border border-red-500/50 mb-4 animate-pulse"><AlertTriangle size={32} className="text-red-500" /></div>
                  <h3 className="text-2xl font-bold text-white">權限未開啟</h3>
                  <p className="text-red-400 mt-2 font-bold">Error: auth/operation-not-allowed</p>
                </div>
                <div className="bg-[#0F0505] p-6 rounded-xl border border-red-900/50 text-left text-sm text-slate-300 space-y-4">
                  <p className="font-bold text-white">這是 Firebase 的安全機制，請依照以下步驟開啟權限：</p>
                  <ol className="list-decimal pl-5 space-y-2">
                    <li>前往 <a href="https://console.firebase.google.com/" target="_blank" className="text-amber-400 hover:underline">Firebase Console</a>。</li>
                    <li>點擊左側選單的 <strong>Build</strong> &gt; <strong>Authentication</strong>。</li>
                    <li>切換到 <strong>Sign-in method</strong> 分頁。</li>
                    <li>找到 <strong>Email/Password</strong>，點擊鉛筆圖示編輯。</li>
                    <li>將 <strong>Enable</strong> 開關打開，然後點擊儲存。</li>
                  </ol>
                  <p className="text-xs text-slate-500 mt-4 border-t border-slate-800 pt-2">如果您使用的是網頁內建的預覽環境，請注意：預覽環境通常無法開啟此權限。請下載 index.html 並填入您自己的 Firebase Config 來執行。</p>
                </div>
                <button onClick={() => setShowAuthErrorModal(false)} className="w-full bg-red-800 hover:bg-red-700 text-white py-3 rounded-xl font-bold mt-6">我了解了</button>
              </div>
            </div>
          )}

          {/* Modals */}
          {showPaymentModal && <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"><div className="bg-[#1a0b0b] border border-red-900/50 rounded-2xl w-full max-w-md p-6 shadow-2xl"><h3 className="font-bold text-xl text-white mb-4">回報匯款資訊</h3><div className="space-y-4"><div className="p-3 bg-yellow-900/20 border border-yellow-700/30 rounded text-sm text-yellow-200">訂單編號: <span className="font-mono">{paymentForm.orderId}</span></div><div><label className="text-sm text-slate-400 mb-1 block">匯款日期</label><input type="date" className="w-full p-3 bg-[#0F0505] border border-red-900/50 rounded text-white outline-none focus:border-amber-500" value={paymentForm.date} onChange={e => setPaymentForm({...paymentForm, date: e.target.value})} /></div><div><label className="text-sm text-slate-400 mb-1 block">帳號後五碼</label><input type="text" maxLength="5" placeholder="例如: 12345" className="w-full p-3 bg-[#0F0505] border border-red-900/50 rounded text-white outline-none focus:border-amber-500 font-mono text-lg tracking-widest" value={paymentForm.last5} onChange={e => setPaymentForm({...paymentForm, last5: e.target.value})} /></div></div><div className="flex gap-2 mt-6"><button onClick={() => setShowPaymentModal(false)} className="flex-1 border border-slate-600 text-slate-300 p-2 rounded hover:bg-slate-800">取消</button><button onClick={handleReportPayment} className="flex-1 bg-red-600 text-white p-2 rounded font-bold hover:bg-red-500">送出回報</button></div></div></div>}
          {showNewsModal && <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"><div className="bg-[#1a0b0b] border border-red-900/50 rounded-2xl w-full max-w-lg p-6 shadow-2xl relative max-h-[80vh] flex flex-col"><div className="flex justify-between items-center mb-6"><h3 className="font-bold text-xl text-white flex items-center gap-2"><Megaphone className="text-amber-400" /> 最新公告</h3><button onClick={() => setShowNewsModal(false)} className="text-slate-500 hover:text-white"><X size={20}/></button></div><div className="space-y-4 overflow-y-auto pr-2 custom-scrollbar">{newsList.length > 0 ? newsList.map(item => (<div key={item.id} className="bg-red-950/10 p-5 rounded-xl border border-red-900/30 hover:border-amber-500/30 transition-all"><div className="flex justify-between items-start mb-2"><h4 className="font-bold text-white text-lg">{item.title}</h4><span className="text-xs text-slate-500 bg-[#0F0505] px-2 py-1 rounded-full">{new Date(item.date).toLocaleDateString()}</span></div><p className="text-slate-300 text-sm whitespace-pre-wrap leading-relaxed">{item.content}</p></div>)) : <div className="text-center py-10 text-slate-500"><Info className="mx-auto mb-2 opacity-50" size={32} />目前沒有最新公告</div>}</div></div></div>}
          {showAddMemberModal && <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"><div className="bg-[#1a0b0b] border border-red-900/50 rounded-2xl w-full max-w-lg p-6 shadow-2xl overflow-y-auto max-h-[90vh]"><h3 className="font-bold text-xl text-white mb-4">手動新增會員</h3><div className="space-y-3"><div className="grid grid-cols-2 gap-3"><input type="text" placeholder="姓名" className="p-3 bg-[#0F0505] border border-red-900/50 rounded text-white outline-none focus:border-amber-500" value={newMember.name} onChange={e => setNewMember({...newMember, name: e.target.value})} /><input type="text" placeholder="電話" className="p-3 bg-[#0F0505] border border-red-900/50 rounded text-white outline-none focus:border-amber-500" value={newMember.phone} onChange={e => setNewMember({...newMember, phone: e.target.value})} /></div><input type="email" placeholder="Email" className="w-full p-3 bg-[#0F0505] border border-red-900/50 rounded text-white outline-none focus:border-amber-500" value={newMember.email} onChange={e => setNewMember({...newMember, email: e.target.value})} /><div className="grid grid-cols-2 gap-3"><input type="date" className="p-3 bg-[#0F0505] border border-red-900/50 rounded text-slate-400 outline-none focus:border-amber-500" value={newMember.birthday} onChange={e => setNewMember({...newMember, birthday: e.target.value})} /><input type="text" placeholder="地址" className="p-3 bg-[#0F0505] border border-red-900/50 rounded text-white outline-none focus:border-amber-500" value={newMember.address} onChange={e => setNewMember({...newMember, address: e.target.value})} /></div><div className="grid grid-cols-2 gap-3"><input type="number" placeholder="初始點數" className="p-3 bg-[#0F0505] border border-red-900/50 rounded text-white outline-none focus:border-amber-500" value={newMember.points} onChange={e => setNewMember({...newMember, points: e.target.value})} /><select className="p-3 bg-[#0F0505] border border-red-900/50 rounded text-white outline-none focus:border-amber-500" value={newMember.level} onChange={e => setNewMember({...newMember, level: e.target.value})}><option>一般會員</option><option>黃金會員</option><option>白金會員</option></select></div></div><div className="flex gap-2 mt-6"><button onClick={() => setShowAddMemberModal(false)} className="flex-1 border border-slate-600 text-slate-300 p-2 rounded hover:bg-slate-800">取消</button><button onClick={handleAdminAddMember} className="flex-1 bg-red-600 text-white p-2 rounded font-bold hover:bg-red-500">確認新增</button></div></div></div>}
          {showProductModal && <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"><div className="bg-[#1a0b0b] border border-red-900/50 rounded-2xl w-full max-w-md p-6 shadow-2xl"><h3 className="font-bold text-xl text-white mb-4">{editingProduct ? '編輯商品' : '新增商品'}</h3><div className="space-y-3"><input type="text" placeholder="商品名稱" className="w-full p-3 bg-[#0F0505] border border-red-900/50 rounded text-white outline-none focus:border-amber-500" value={productForm.name} onChange={e => setProductForm({...productForm, name: e.target.value})} /><input type="number" placeholder="價格" className="w-full p-3 bg-[#0F0505] border border-red-900/50 rounded text-white outline-none focus:border-amber-500" value={productForm.price} onChange={e => setProductForm({...productForm, price: e.target.value})} /><input type="text" placeholder="描述" className="w-full p-3 bg-[#0F0505] border border-red-900/50 rounded text-white outline-none focus:border-amber-500" value={productForm.desc} onChange={e => setProductForm({...productForm, desc: e.target.value})} /><input type="text" placeholder="圖片網址" className="w-full p-3 bg-[#0F0505] border border-red-900/50 rounded text-white outline-none focus:border-amber-500" value={productForm.image} onChange={e => setProductForm({...productForm, image: e.target.value})} /></div><div className="flex gap-2 mt-6"><button onClick={() => setShowProductModal(false)} className="flex-1 border border-slate-600 text-slate-300 p-2 rounded hover:bg-slate-800">取消</button><button onClick={handleSaveProduct} className="flex-1 bg-red-600 text-white p-2 rounded font-bold hover:bg-red-500">儲存</button></div></div></div>}
          {showPointModal && <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"><div className="bg-[#1a0b0b] border border-red-900/50 rounded-2xl w-full max-w-md p-6 shadow-2xl"><h3 className="font-bold text-xl text-white mb-1">點數調整</h3><p className="text-slate-500 text-sm mb-6">對象: {pointForm.memberName}</p><div className="space-y-4"><div><label className="text-xs text-slate-400 mb-1 block">變動理由</label><input type="text" placeholder="例如: 購買回饋, 生日禮金" className="w-full p-3 bg-[#0F0505] border border-red-900/50 rounded text-white outline-none focus:border-amber-500" value={pointForm.reason} onChange={e => setPointForm({...pointForm, reason: e.target.value})} /></div><div><label className="text-xs text-slate-400 mb-1 block">點數增減 (負數為扣除)</label><input type="number" className="w-full p-3 bg-[#0F0505] border border-red-900/50 rounded text-cyan-400 font-mono text-xl outline-none focus:border-amber-500" value={pointForm.amount} onChange={e => setPointForm({...pointForm, amount: e.target.value})} /></div></div><div className="flex gap-2 mt-6"><button onClick={() => setShowPointModal(false)} className="flex-1 border border-slate-600 text-slate-300 p-3 rounded-xl hover:bg-slate-800">取消</button><button onClick={handlePointAdj} className="flex-1 bg-gradient-to-r from-red-600 to-orange-600 text-white p-3 rounded-xl font-bold hover:shadow-lg">確認調整</button></div></div></div>}
          {showOrderDetailModal && selectedOrder && (
            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"><div className="bg-[#1a0b0b] border border-red-900/50 rounded-2xl w-full max-w-lg p-8 shadow-2xl relative"><div className="flex justify-between items-start mb-6"><div><h3 className="text-xl font-bold flex items-center gap-2 text-white"><Package className="text-amber-400" /> 訂單詳情</h3><span className="text-sm text-slate-500 font-mono">{selectedOrder.orderId}</span></div><button onClick={() => setShowOrderDetailModal(false)} className="text-slate-500 hover:text-white"><X /></button></div><div className="bg-red-950/10 border border-red-900/30 p-4 rounded-xl mb-6 space-y-2 text-sm text-slate-300"><div className="font-bold text-slate-200 border-b border-red-900/30 pb-2 mb-2">收件人資料</div><div className="grid grid-cols-[60px_1fr] gap-2"><span className="text-slate-500">姓名:</span> <span className="text-white">{selectedOrder.shippingInfo?.name || selectedOrder.memberName}</span><span className="text-slate-500">電話:</span> <span className="text-white">{selectedOrder.shippingInfo?.phone}</span><span className="text-slate-500">地址:</span> <span className="text-white">{selectedOrder.shippingInfo?.address}</span></div>{selectedOrder.paymentInfo && <div className="mt-4 pt-2 border-t border-red-900/30"><div className="text-yellow-400 font-bold mb-1">匯款資訊</div><div>後五碼: {selectedOrder.paymentInfo.last5}</div><div>日期: {selectedOrder.paymentInfo.date}</div></div>}</div><div className="space-y-3 mb-8">{selectedOrder.items.map((item, idx) => (<div key={idx} className="flex justify-between items-center text-sm border-b border-red-900/30 pb-2 text-slate-300"><div><div className="font-bold text-white">{item.name}</div><div className="text-xs text-slate-500">${item.unitPrice} x {item.quantity} (Rate: {item.discountRate})</div></div><div className="font-bold text-white">${Math.round(item.unitPrice * item.discountRate * item.quantity)}</div></div>))}<div className="flex justify-between items-center text-lg font-black pt-2"><span className="text-white">Total</span><span className="text-amber-400 text-2xl">${selectedOrder.totalAmount}</span></div></div><div className="flex gap-3">{isAdmin && selectedOrder.status === 'verifying' && <button onClick={() => { handleConfirmPayment(selectedOrder.orderId, selectedOrder.memberId); setShowOrderDetailModal(false); }} className="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold">確認收款</button>}{selectedOrder.status !== 'shipped' ? <button onClick={() => { handleUpdateOrderStatus(selectedOrder.memberId, selectedOrder.orderId, 'shipped'); setShowOrderDetailModal(false); }} className="flex-1 bg-green-600 hover:bg-green-500 text-white py-3 rounded-xl font-bold flex justify-center items-center gap-2 shadow-[0_0_15px_rgba(34,197,94,0.3)]"><Truck size={18} /> 標記為已出貨</button> : <div className="flex-1 bg-slate-800 border border-slate-700 text-slate-500 py-3 rounded-xl font-bold flex justify-center items-center gap-2 cursor-not-allowed"><CheckCircle size={18} /> 訂單已完成</div>}</div></div></div>
          )}
        </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
